create or replace TRIGGER DENY_RESULT_INSERTION
BEFORE INSERT ON SERIECLASSIFICACAO
FOR EACH ROW
DECLARE ETAPA_ATUAL NVARCHAR2(14);
        JA_INSERIDO NUMBER;
        STATUS_ATLETA_SERIE_ANTERIOR NVARCHAR2(14);

BEGIN

  SELECT COUNT(*),S.ETAPA INTO JA_INSERIDO, ETAPA_ATUAL
  FROM SERIECLASSIFICACAO SC
	INNER JOIN SERIE S
	ON S.CODSERIE = SC.CODSERIE
  WHERE :NEW.CODATLETA = SC.CODATLETA
  GROUP BY S.ETAPA;

  IF JA_INSERIDO > 0
  THEN
  	RAISE_APPLICATION_ERROR(-20002,'RESULTADO JA INSERIDO');
  END IF;
  
  IF ETAPA_ATUAL = 'FINAL'
  THEN
  	SELECT SC.STATUSCLASSIFICACAOATLETA INTO STATUS_ATLETA_SERIE_ANTERIOR
  	FROM SERIECLASSIFICACAO SC
		INNER JOIN SERIE S
		ON S.CODSERIE = SC.CODSERIE
  	WHERE :NEW.CODATLETA = SC.CODATLETA
	AND S.ETAPA = 'SEMIFINAL';
	
	IF STATUS_ATLETA_SERIE_ANTERIOR != 'CLASSIFICADO'
	THEN
		RAISE_APPLICATION_ERROR(-20003,'ATLETA NAO CLASSIFICADO');
	END IF;
  END IF;

  IF ETAPA_ATUAL = 'SEMIFINAL'
  THEN
  	SELECT SC.STATUSCLASSIFICACAOATLETA INTO STATUS_ATLETA_SERIE_ANTERIOR
  	FROM SERIECLASSIFICACAO SC
		INNER JOIN SERIE S
		ON S.CODSERIE = SC.CODSERIE
  	WHERE :NEW.CODATLETA = SC.CODATLETA
	AND S.ETAPA = 'ELIMINATORIA';
	
	IF STATUS_ATLETA_SERIE_ANTERIOR != 'CLASSIFICADO'
	THEN
		RAISE_APPLICATION_ERROR(-20003,'ATLETA NAO CLASSIFICADO');
	END IF;
  END IF;


END DENY_RESULT_INSERTION;